# 東京都の国基準コロナデータの csv 化

重要な注意事項があります。  
- (a) このリポジトリには、東京都がこのデータを公表し始めてから 2021-06-29 までのデータはありません。  
（東京都は、今年の春からこの形式のデータを公表していたようです。）
- (b) 2021-06-30〜2021-07-05 においては、重傷者数のデータ、並びに重傷者病床数のデータのみがあります。
- (c) 2021-07-06 以降においては、今のところ全てのデータがあります。

(a)(b) は、東京都がデータを1日毎に削除しているのが主な原因です。  
例えば 2021-07-10 のデータを公表する際、東京都は 2021-07-09 のデータを削除しています。  
現在、手元では、東京都が日々公表するデータを自動的に取得するようにしていますが、何らかの事情で取得に失敗し、回復もできない可能性があります。  
この場合、該当するデータが作成できない日が生じる可能性があります。

## Last Update

2021-08-30  
t0 形式のデータを作成するようにしました。  
ただし、2021-09-06 ぐらいまでは暫定期間とし、必要があれば、形式を変更します。  
t0 形式の実質的な内容は t1 形式と同じですが、内容を組み替えてあります。  
表頭については、[こちら](#t0-形式について) もご参照下さい。

## URL

https://github.com/sarkov28/c19_tokyo_kunishihyou

## Features

東京都が https://www.fukushihoken.metro.tokyo.lg.jp/iryo/kansen/corona_portal/info/kunishihyou.html で公表している国基準データ pdf のうち、2021-07 末以降に waybackmachine（web.archive.org）で入手可能なものの csv 化を試みました。  
2021-08-02 時点で、2021-07-06〜2021-08-01 のデータが入手可能でした。  
今後の更新では、自動ダウンロードしたデータ pdf から csv 化していく予定です。

ファイル名が t0、t1 で始まっているファイルは、
- 全日付で1つのファイルです。
- 日付のカラムを追加してあります。

ファイル名が t2 で始まっているファイルは、
- 日付毎のファイルにです。
- pdf を比較的そのまま csv 化したファイルです。

t1 の形式、t2 の形式、どちらにおいても、
- (1a) 各日付において、データ行（＝表頭ではない行）は7行あります。
- (1b) 7行のデータの順序は安定していると思われます。
- (1c) データ行の右2つのカラム（＝実質的なデータカラム）は安定していると思われます。
- (1d) その左2つのカラムは、不安定です。

(1c) に示したように、実質的なデータのカラムは安定していると思われます。

t0、t1 形式のファイルは、プログラム等で処理しやすいことを意図して作成したのですが、フォーマットの揺れがあるので微妙です。

## Note

このデータの作成にあたっては、python を使い、tabula.read_pdf() で DataFrame に変換してから処理しました。

この際、以下の問題がありました。  
これらが tabula.read_pdf() を含む処理系の問題なのか、ソースデータの pdf の問題なのかは調べていませんが、(2b) に書いたフォーマットの変化を考えると、ソースデータの問題なのかも知れません。

- (2a) 2021年7月の短い期間の間にも、変換した DataFrame のフォーマットが何度も変化しています。
- (2b) pdf の表示ではデータの入っているカラムが、DataFrame では無くなっている（＝空欄になっているのではない）ことがあります。（私は読み込んだデータを全て出力しています。ある日に存在したカラムが、別の日に無くなっていることがあります。）

このため、得られた csv は、残念ながらよく注意しながら取り扱う必要があります。

## Detail

### pdf から csv への変換方法
pdf ファイルから DataFrame を得るには、上述したように python + tabula.read_pdf() を使っています。  
得られた DataFrame はそのままでは表になっていなかったので、適宜加工しています。

### pdf ファイルの入手方法
pdf ファイルの入手方法は、2021-08-01 以前と以後で異なります。

2021-08-01 以前は、以下の方法です。
- pdf ファイルの url は、7月31日の場合、url=https://www.fukushihoken.metro.tokyo.lg.jp/iryo/kansen/corona_portal/info/kunishihyou.files/kuni0731.pdf である。
- url がわかると、そのファイルのアーカイブが waybackmachine に保存されているのか、また保存されているならその url は何かを、https://archive.org/help/wayback_api.php の先頭に記載されている API で知ることができる。
- この url をダウンロードすれば、pdf ファイルが入手できる。

2021-08-02 以後は、以下の方法です。
- https://www.fukushihoken.metro.tokyo.lg.jp/iryo/kansen/corona_portal/info/kunishihyou.html の記載から、pdf ファイルの url を知ることができる。
- この url をダウンロードすれば、pdf ファイルが入手できる。

### t0 形式について
t0 形式のデータは、t2 形式のデータを変換して作成しています。  
この際、表頭として何を採用すべきかは、必ずしも自明ではないと思えました。  

このため、pdf データにおける下から 3 行、「病床全体の使用率」「入院率」「重症者用病床の使用率」に該当する項目の一部では、表頭として「……_分子」「……_分母」という機械的な名称を採用しています。

## Plan

東京都は、このリポジトリの元となるデータ
https://www.fukushihoken.metro.tokyo.lg.jp/iryo/kansen/corona_portal/info/kunishihyou.html
を、休日も含め、毎日更新しているようです。

このリポジトリは、当面の間、週に1度程度は更新しようと思っています。

2021-08-01 までのデータは、waybackmachine（web.archive.org）のデータに依存しています。この方法だと、waybackmachine にデータがないと処理出来ません。

2021-08-02 以降は、東京都のサイト https://www.fukushihoken.metro.tokyo.lg.jp/iryo/kansen/corona_portal/info/kunishihyou.html から該当のデータ pdf を手元に自動でダウンロードするようにしたので、（waybackmachine にデータがなくても）そこから処理できるはずです。

ただし、手元のPCにトラブルがあった場合には、この自動ダウンロードが失敗する可能性があります。  
自動ダウンロードに失敗しても、waybackmachine にデータがあれば回復できますが、waybackmachine にデータがあるとは限りません。
この場合、該当するデータが作成できない日が生じる可能性があります。

また、元となるデータ pdf の発表方法やフォーマットなどに大きな変化があった場合は、更新を諦めるかも知れません。

## FAQ

いかにも疑問に思われそうな箇所について、予め書いておきます。

(1)  
問  
t1 の形式のファイルには、なぜ表頭の行（＝"日付" で始まる行）が複数あるのか。  
答  
表頭に該当する行も日によって一定しておらず、不安定です。  
例えば、07-16 の表頭の行は、"区分" の次のカラムがありません。  
他を参照するなどしてこれを私が埋めるのは不適切だと考えました。  
この状態をそのまま示すため、表頭の行を各日付で出力しています。  
（この「私が埋めるのは不適切」の方針は、2021-06-30〜2021-07-05 のデータには適用していません。この期間のデータでは「私が表頭に該当する箇所を、適宜、埋めています」。）  
（この方針は、t0 形式のデータには適用していません。）

## Update Log

2021-08-05  
指摘をいただき、改行コードと文字コードの問題があることに気づき、これを修正しました。  
windows では文字化けや、Excel での読み込みエラーが発生していたと思います。  
「utf-8、LF8」だったのですが、これを「shift_jis、CR+LF」に変更しました。  

2021-08-12  
twitter ほりぐちさん https://twitter.com/mstk_Horiguchi から、2021-06-30〜2021-07-05 の重症者数のデータを頂きました。  
また、ほりぐちさんによると、この間に重傷者病床数に変化は無かったとのことでした。  
これらの情報から、重症者数の行だけにデータが入っている t2 形式ファイル t2_2021-06-30.csv 〜 t2_2021-07-05 を作成しました。  
さらにこれらを用いて、t1 形式ファイル t1_kunishihyou.csv を作成しました。  
（この期間においては、重症者数以外のデータはありません。）

## Author

https://twitter.com/sarkov28

twitter やブログに、コロナに関することを色々と書いています。

- 新型コロナ関連の主な事柄のリスト  
  https://sarkov28.hatenablog.com/entry/2021/01/25/193020
- 新型コロナ関連の主な事柄のリスト（特に重要な項目）  
  https://sarkov28.hatenablog.com/entry/2021/01/25/193753

## License

このリポジトリにあるデータは、東京都公表のデータを加工したものです。  
自由に使っていただいて構いませんが、内容は保証出来ません。  
フォーマットの揺れがあるため、思わぬ問題が発生している可能性があります。
